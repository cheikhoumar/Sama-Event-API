{"version":3,"file":"18-ClIvaUVV.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/auth/login/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/18.js"],"sourcesContent":["import \"../../../../chunks/config.js\";\nimport { r as redisClient } from \"../../../../chunks/redis.js\";\nimport { G as Group } from \"../../../../chunks/group.enum.js\";\nimport { f as fail, r as redirect } from \"../../../../chunks/index.js\";\nimport { compare } from \"bcrypt\";\nimport jwt from \"jsonwebtoken\";\nimport { config } from \"@backtix-service/config\";\nconst load = async () => {\n  return {};\n};\nconst actions = {\n  default: async (event) => {\n    const { username, password } = Object.fromEntries(await event.request.formData());\n    const user = await prisma.user.findUnique({\n      where: {\n        username,\n        groups: { hasSome: [Group.ADMIN, Group.SUPERADMIN] }\n      }\n    });\n    if (!user) return fail(404, { message: \"User not found\", username });\n    const passwordValid = await validatePassword(password, user.password);\n    if (!passwordValid) return fail(401, { message: \"Wrong password\", username });\n    const refreshToken = jwt.sign(\n      { sub: user.id, username: user.username, email: user.email },\n      config.security.refreshTokenKey,\n      { expiresIn: config.security.refreshTokenExpiration }\n    );\n    const accessToken = jwt.sign(\n      { sub: user.id, username: user.username, email: user.email },\n      config.security.accessTokenKey,\n      { expiresIn: config.security.accessTokenExpiration }\n    );\n    event.cookies.set(\"refreshToken\", refreshToken, {\n      httpOnly: true,\n      maxAge: 60 * 60 * 24 * 30,\n      sameSite: \"strict\",\n      path: \"/\"\n    });\n    event.cookies.set(\"accessToken\", accessToken, {\n      httpOnly: true,\n      maxAge: 60 * 60 * 24,\n      sameSite: \"strict\",\n      path: \"/\"\n    });\n    await redisClient.set(refreshToken, JSON.stringify({ id: user.id }), {\n      EX: config.security.refreshTokenTTL\n    });\n    return redirect(303, \"/admin\");\n  }\n};\nfunction validatePassword(password, hashedPassword) {\n  return compare(password, hashedPassword);\n}\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/auth/login/_page.server.ts.js';\n\nexport const index = 18;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/auth/login/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/auth/login/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/18.BdfUjH85.js\",\"_app/immutable/chunks/scheduler.DFZBBKhI.js\",\"_app/immutable/chunks/index.LUCKkj9k.js\",\"_app/immutable/chunks/Alert.BGCmzfzt.js\",\"_app/immutable/chunks/bundle-mjs.CuhWIVwh.js\",\"_app/immutable/chunks/CloseButton.vrK9mPVw.js\",\"_app/immutable/chunks/Frame.DNz3Vx4g.js\",\"_app/immutable/chunks/Button.CrNIN95s.js\",\"_app/immutable/chunks/Label.CF2lxgNY.js\",\"_app/immutable/chunks/Input.DjV6Ntai.js\",\"_app/immutable/chunks/Wrapper.Dkm7VoO3.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":["config","compare"],"mappings":"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"}